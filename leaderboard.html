<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Leaderboard</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="1Forside.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html" class="active">Leaderboard</a>
    <a href="2Contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto mt-8 p-6 bg-white shadow rounded-lg">

  <h1 class="text-3xl font-bold text-center mb-6">
    üåç Global Leaderboard
  </h1>

  <div id="loading" class="text-center text-gray-500">
    Indl√¶ser leaderboard...
  </div>

  <table class="w-full border-collapse hidden" id="leaderboard-table">
    <thead>
      <tr class="bg-gray-200 border-b">
        <th class="p-3 text-left">Placering</th>
        <th class="p-3 text-left">Bruger</th>
        <th class="p-3 text-left">Point</th>
        <th class="p-3 text-left">Korrekt resultat</th>
        <th class="p-3 text-left">Korrekt udfald</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

</main>

<script>
  // ================= Firebase =================
  const firebaseConfig = {
    apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
    authDomain: "trampestips.firebaseapp.com",
    projectId: "trampestips",
    storageBucket: "trampestips.firebasestorage.app",
    messagingSenderId: "759235788489",
    appId: "1:759235788489:web:9515bc438a7c7d68469718",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ================= Auth check =================
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "gaet_login.html";
      return;
    }
    await loadGlobalLeaderboard();
  });

  // ================= Leaderboard logic =================
  async function loadGlobalLeaderboard() {
    const leaderboardBody = document.getElementById("leaderboard-body");
    const table = document.getElementById("leaderboard-table");
    const loading = document.getElementById("loading");

    leaderboardBody.innerHTML = "";

    // Hent alle f√¶rdigspillede kampe
    const matchesSnap = await db.collection("matches")
      .where("homeGoals", "!=", null)
      .get();

    const matches = {};
    matchesSnap.forEach(doc => {
      matches[doc.id] = doc.data();
    });

    // Hent alle brugere
    const usersSnap = await db.collection("users").get();

    const leaderboard = [];

    for (const userDoc of usersSnap.docs) {
      const user = userDoc.data();
      const guessesSnap = await db
        .collection("users")
        .doc(userDoc.id)
        .collection("guesses")
        .get();

      let point = 0;
      let correctResult = 0;
      let correctOutcome = 0;

      guessesSnap.forEach(gDoc => {
        const guess = gDoc.data();
        const match = matches[gDoc.id];
        if (!match) return;

        const exact =
          guess.homeGoals === match.homeGoals &&
          guess.awayGoals === match.awayGoals;

        const outcome =
          (guess.homeGoals > guess.awayGoals && match.homeGoals > match.awayGoals) ||
          (guess.homeGoals < guess.awayGoals && match.homeGoals < match.awayGoals) ||
          (guess.homeGoals === guess.awayGoals && match.homeGoals === match.awayGoals);

        if (exact) {
          point += 3;
          correctResult++;
        } else if (outcome) {
          point += 1;
          correctOutcome++;
        }
      });

      leaderboard.push({
        username: user.username,
        point,
        correctResult,
        correctOutcome
      });
    }

    leaderboard.sort((a, b) => b.point - a.point);

    leaderboard.forEach((u, index) => {
      const tr = document.createElement("tr");
      tr.className = "border-b";

      tr.innerHTML = `
        <td class="p-3 font-semibold">${index + 1}</td>
        <td class="p-3">${u.username}</td>
        <td class="p-3 font-bold">${u.point}</td>
        <td class="p-3">${u.correctResult}</td>
        <td class="p-3">${u.correctOutcome}</td>
      `;
      leaderboardBody.appendChild(tr);
    });

    loading.classList.add("hidden");
    table.classList.remove("hidden");
  }
</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover,
.menu-bar a.active {
  text-decoration: underline;
}
</style>

</body>
</html>
