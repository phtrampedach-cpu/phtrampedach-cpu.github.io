<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Leaderboard</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html" >Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html"class="active">Leaderboard</a>
    <a href="2Contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-4 text-center">Leaderboard</h1>

  <div class="flex justify-center gap-3 mb-4" id="tournament-selector">
    <button data-tournament="VM2026" class="tournament-btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">VM 2026</button>
    <button data-tournament="Superliga" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Superliga Forår 2026</button>
    <button data-tournament="PremierLeague" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Premier League Forår 2026</button>
  </div>

  <div id="leaderboard-container" class="space-y-2 text-gray-800">
    Indlæser...
  </div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let selectedTournament = "VM2026";

// ===== Turnering valg =====
document.querySelectorAll('.tournament-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedTournament = btn.dataset.tournament;

    document.querySelectorAll('.tournament-btn').forEach(b => {
      if(b===btn){
        b.classList.remove('bg-gray-300','text-gray-800');
        b.classList.add('bg-blue-600','text-white');
      } else {
        b.classList.remove('bg-blue-600','text-white');
        b.classList.add('bg-gray-300','text-gray-800');
      }
    });

    loadLeaderboard(selectedTournament);
  });
});

// ===== Beregn point =====
function calculatePoints(guess, match) {
  const exact = guess.homeGoals === match.homeGoals && guess.awayGoals === match.awayGoals;
  const outcome =
    (match.homeGoals > match.awayGoals && guess.homeGoals > guess.awayGoals) ||
    (match.homeGoals < match.awayGoals && guess.homeGoals < guess.awayGoals) ||
    (match.homeGoals === match.awayGoals && guess.homeGoals === guess.awayGoals);

  if (exact) return { points: 3, exact: 1, outcome: 0 };
  if (outcome) return { points: 1, exact: 0, outcome: 1 };
  return { points: 0, exact: 0, outcome: 0 };
}

// ===== Load leaderboard =====
async function loadLeaderboard(selectedTournament) {
  const lbContainer = document.getElementById("leaderboard-container");
  lbContainer.innerHTML = "Indlæser...";

  // 1️⃣ Hent alle brugere
  const usersSnap = await db.collection("users").get();
  const users = {};
  usersSnap.forEach(doc => {
    users[doc.id] = { username: doc.data().username, points: 0, correctResult: 0, correctOutcome: 0 };
  });

  // 2️⃣ Hent alle kamp-resultater for turneringen
  const matchesSnap = await db.collection("matches")
                              .where("tournament", "==", selectedTournament)
                              .get();
  const matches = {};
  matchesSnap.forEach(doc => {
    matches[doc.id] = doc.data();
  });

  // 3️⃣ Beregn point for alle gæt
  for (const userId in users) {
    const guessesSnap = await db.collection("users").doc(userId).collection("guesses").get();
    guessesSnap.forEach(doc => {
      const guess = doc.data();
      const match = matches[doc.id];
      if (!match || match.homeGoals === null || match.awayGoals === null) return;

      const result = calculatePoints(guess, match);
      users[userId].points += result.points;
      users[userId].correctResult += result.exact;
      users[userId].correctOutcome += result.outcome;
    });
  }

  // 4️⃣ Opdater leaderboard i Firestore (opret alle brugere med 0 point)
  for (const userId in users) {
    await db.collection("leaderboards")
            .doc(selectedTournament)
            .collection("users")
            .doc(userId)
            .set({
              username: users[userId].username,
              points: users[userId].points,
              correctResult: users[userId].correctResult,
              correctOutcome: users[userId].correctOutcome,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
  }

  // 5️⃣ Vis leaderboard på siden
  const sortedUsers = Object.values(users).sort((a,b) => b.points - a.points);
  lbContainer.innerHTML = "";
  sortedUsers.forEach((u, i) => {
    const div = document.createElement("div");
    div.className = "flex justify-between border-b py-2 px-4";
    div.innerHTML = `
      <span>${i+1}. ${u.username}</span>
      <span>${u.points} point</span>
    `;
    lbContainer.appendChild(div);
  });
}

// ===== Check login =====
auth.onAuthStateChanged(user => {
  if (!user) { window.location.href = "gaet_login.html"; return; }
  loadLeaderboard(selectedTournament);
});
</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover, .menu-bar a.active {
  text-decoration: underline;
}
</style>

</body>
</html>
