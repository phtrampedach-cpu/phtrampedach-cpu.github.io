<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin – Kampstyring</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="kampe.html">Kampe</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="admin.html" style="display:none;">Admin</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-4 text-center">Admin – Kampstyring</h1>

  <div class="flex justify-center mb-4">
    <select id="tournamentFilter" class="border px-3 py-2 rounded">
      <option value="">Vælg turnering...</option>
      <option value="VM2026">VM 2026</option>
      <option value="Superliga">Superliga Forår 2026</option>
      <option value="PremierLeague">Premier League Forår 2026</option>
    </select>
  </div>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>
  <div id="kampe-container" class="space-y-4"></div>
  <div class="flex justify-center mt-4">
    <button id="save-all-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gem alle kampe</button>
  </div>
  <div id="save-notice" class="hidden text-green-700 font-semibold mb-2 text-center mt-2"></div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "p.h.trampedach@gmail.com";
const kampeContainer = document.getElementById("kampe-container");
const saveNotice = document.getElementById("save-notice");
const saveAllBtn = document.getElementById("save-all-btn");
const tournamentFilter = document.getElementById("tournamentFilter");
let selectedTournament = "";

// ----- Check admin-login -----
auth.onAuthStateChanged(async user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    window.location.href = "gaet_login.html";
    return;
  }
  document.getElementById("user-info").textContent = `Logget ind som admin: ${user.email}`;
});

// ----- Load matches -----
async function loadMatchesForTournament(tournament) {
  if (!tournament) {
    kampeContainer.innerHTML = `<p class="text-center text-gray-500">Vælg en turnering.</p>`;
    return;
  }
  selectedTournament = tournament;
  kampeContainer.innerHTML = `<p class="text-center text-gray-500">Indlæser kampe...</p>`;
  const matchesSnap = await db.collection("matches")
    .where("tournament","==",tournament)
    .orderBy("date").get();
  kampeContainer.innerHTML = "";

  matchesSnap.forEach(doc => {
    const match = { id: doc.id, ...doc.data() };
    const div = document.createElement("div");
    div.className = "p-3 rounded-lg border flex justify-between items-center gap-4";
    div.dataset.matchId = match.id;
    div.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="font-semibold">${match.homeTeam}</span>
        <input type="number" min="0" class="homeGoals border rounded w-16 text-center" value="${match.homeGoals ?? ''}">
        <span class="font-bold text-xl">vs</span>
        <input type="number" min="0" class="awayGoals border rounded w-16 text-center" value="${match.awayGoals ?? ''}">
        <span class="font-semibold">${match.awayTeam}</span>
      </div>
      <div class="text-sm text-gray-500">${match.date} ${match.time}</div>
    `;
    kampeContainer.appendChild(div);
  });
}

// ----- Calculate points -----
function calculatePoints(guess, match) {
  const exact = guess.homeGoals === match.homeGoals && guess.awayGoals === match.awayGoals;
  const outcome =
    (guess.homeGoals > guess.awayGoals && match.homeGoals > match.awayGoals) ||
    (guess.homeGoals < guess.awayGoals && match.homeGoals < match.awayGoals) ||
    (guess.homeGoals === guess.awayGoals && match.homeGoals === match.awayGoals);

  if (exact) return { points: 3, exact: 1, outcome: 0 };
  if (outcome) return { points: 1, exact: 0, outcome: 1 };
  return { points: 0, exact: 0, outcome: 0 };
}

// ----- Update leaderboard -----
async function updateLeaderboardForMatch(matchId) {
  const matchSnap = await db.collection("matches").doc(matchId).get();
  if (!matchSnap.exists) return;

  const match = matchSnap.data();
  if (match.homeGoals === null || match.awayGoals === null) return;

  const tournament = match.tournament;
  const usersSnap = await db.collection("users").get();

  for (const userDoc of usersSnap.docs) {
    const userId = userDoc.id;
    const username = userDoc.data().username;

    const guessSnap = await db.collection("users").doc(userId)
      .collection("guesses").doc(matchId).get();

    const guess = guessSnap.exists ? guessSnap.data() : {homeGoals:null, awayGoals:null};
    const result = calculatePoints(guess, match);

    // Save per match
    await db.collection("userMatchPoints").doc(tournament)
      .collection("users").doc(userId)
      .collection("matches").doc(matchId)
      .set(result);

    // Update total leaderboard
    await db.collection("leaderboards").doc(tournament)
      .collection("users").doc(userId)
      .set({
        username,
        points: firebase.firestore.FieldValue.increment(result.points),
        correctResult: firebase.firestore.FieldValue.increment(result.exact),
        correctOutcome: firebase.firestore.FieldValue.increment(result.outcome)
      }, { merge: true });
  }
}

// ----- Save all matches -----
saveAllBtn.addEventListener('click', async () => {
  if (!selectedTournament) { alert("Vælg en turnering!"); return; }
  saveNotice.textContent = "Gemmer kampe...";
  saveNotice.classList.remove("hidden");

  const matchDivs = document.querySelectorAll('#kampe-container > div');

  for (const div of matchDivs) {
    const matchId = div.dataset.matchId;
    const home = div.querySelector('.homeGoals').value;
    const away = div.querySelector('.awayGoals').value;
    const homeGoals = home === "" ? null : Number(home);
    const awayGoals = away === "" ? null : Number(away);

    await db.collection("matches").doc(matchId).update({ homeGoals, awayGoals });
    await updateLeaderboardForMatch(matchId);
  }

  saveNotice.textContent = "Alle kampe er gemt og leaderboard opdateret!";
  setTimeout(() => saveNotice.classList.add("hidden"), 3000);
});

// ----- Tournament dropdown -----
tournamentFilter.addEventListener('change', e => loadMatchesForTournament(e.target.value));
</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover, .menu-bar a.active { text-decoration: underline; }
</style>

</body>
</html>
