<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>G칝t p친 kampene</title>
<link rel="stylesheet" href="styles.css">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-6 text-center">G칝t p친 kampene</h1>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>

  <!-- ADMIN: Importer kampe -->
  <button id="import-btn" onclick="importMatches()" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">
    Importer alle kampe til Firestore
  </button>

  <!-- Gem alle g칝t -->
  <button id="save-all" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 hover:bg-blue-700">
    Gem alle g칝t
  </button>
  <div id="save-notice" class="hidden text-green-700 font-semibold mb-2 text-center"></div>

  <div id="kampe-container" class="space-y-4"></div>

  <div id="total-points" class="text-xl font-semibold text-center mt-6"></div>
</main>

<script>
  // ======================
  // Firebase setup
  // ======================
  const firebaseConfig = {
    apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
    authDomain: "trampestips.firebaseapp.com",
    projectId: "trampestips",
    storageBucket: "trampestips.firebasestorage.app",
    messagingSenderId: "759235788489",
    appId: "1:759235788489:web:9515bc438a7c7d68469718",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const ADMIN_EMAIL = "p.h.trampedach@gmail.com";
  const kampeContainer = document.getElementById("kampe-container");
  const totalPointsEl = document.getElementById("total-points");
  let currentUser = null;

  // Lokale flag-stier
  const flags = {
    "Danmark": "Billeder/danmark.png",
    "Tyskland": "Billeder/tyskland.png",
    "England": "Billeder/england.png",
    "Frankrig": "Billeder/frankrig.png",
    "Japan": "Billeder/japan.png",
    "Kroatien": "Billeder/kroatien.png",
    "Norge": "Billeder/norge.png",
    "Portugal": "Billeder/portugal.png",
    // ... forts칝t med alle 64 flag
  };

  // ===== Check login =====
  auth.onAuthStateChanged(async (user) => { 
    if (!user) {
      window.location.href = "gaet_login.html";
      return;
    }
    
    currentUser = user;
    document.getElementById("user-info").textContent = "Logget ind som: " + user.email;
    
    // 游댳 Skjul import-knap for alle andre end admin
    if (currentUser.email !== ADMIN_EMAIL) {
      document.getElementById("import-btn").style.display = "none";
    }
    
    await loadKampe();
  });

  // ===== Hent kampe + g칝t =====
  async function loadKampe() {
    kampeContainer.innerHTML = `<p class="text-center text-gray-500">Indl칝ser kampe...</p>`;
    const matchesSnap = await db.collection("matches").orderBy("date").get();
    const guessesSnap = await db.collection("users").doc(currentUser.uid).collection("guesses").get();
    const guesses = {};
    guessesSnap.forEach(doc => guesses[doc.id] = doc.data());
    kampeContainer.innerHTML = "";

    let totalPoints = 0;

    matchesSnap.forEach(doc => {
      const match = { id: doc.id, ...doc.data() };
      const userGuess = guesses[match.id] || {};

      const [year, month, day] = match.date.split("-").map(Number); // format YYYY-MM-DD
      const [hour, minute] = match.time.split(":").map(Number);
      const matchDateTime = new Date(year, month-1, day, hour, minute);
      const now = new Date();
      const isLocked = now > new Date(matchDateTime.getTime() - 60*60*1000); // 1 time f칮r kamp

      // Beregn point
      let points = 0;
      if (match.homeGoals != null && match.awayGoals != null && userGuess.homeGoals != null && userGuess.awayGoals != null) {
        const correctOutcome = match.homeGoals === match.awayGoals ? "draw" : match.homeGoals > match.awayGoals ? "home" : "away";
        const userOutcome = userGuess.homeGoals === userGuess.awayGoals ? "draw" : userGuess.homeGoals > userGuess.awayGoals ? "home" : "away";
        if (correctOutcome === userOutcome) points += 1;
        if (match.homeGoals === userGuess.homeGoals && match.awayGoals === userGuess.awayGoals) points += 2;
        totalPoints += points;
      }

      // Farver kun p친 input-felterne
let homeColorClass = "";
let awayColorClass = "";

if (match.homeGoals != null && match.awayGoals != null && userGuess.homeGoals != null && userGuess.awayGoals != null) {
    if (points === 3) {
        homeColorClass = awayColorClass = "bg-green-400";
    } else if (points === 1) {
        homeColorClass = awayColorClass = "bg-blue-400";
    } else {
        homeColorClass = awayColorClass = "bg-red-400";
    }
}

if (isLocked) {
    homeColorClass = awayColorClass = "bg-gray-300"; // l친st
}

// Kamp div
const kampDiv = document.createElement("div");
kampDiv.className = `p-3 rounded-lg border border-gray-300 shadow-md kamp`;
kampDiv.dataset.matchId = match.id;

kampDiv.innerHTML = `
  <div class="flex items-center justify-between gap-4">
    <img src="${flags[match.homeTeam]}" class="w-8 h-8">
    <span class="font-semibold">${match.homeTeam}</span>
    <input type="number" min="0" class="homeGoals border rounded w-12 text-center ${homeColorClass}" value="${userGuess.homeGoals ?? ''}" ${isLocked ? 'disabled' : ''}>

    <span class="font-bold text-xl">vs</span>

    <input type="number" min="0" class="awayGoals border rounded w-12 text-center ${awayColorClass}" value="${userGuess.awayGoals ?? ''}" ${isLocked ? 'disabled' : ''}>
    <span class="font-semibold">${match.awayTeam}</span>
    <img src="${flags[match.awayTeam]}" class="w-8 h-8">

    <span class="text-sm text-gray-500 ml-4">${match.date} ${match.time}</span>
  </div>

  <div class="mt-2 text-sm text-gray-700">
    ${match.homeGoals != null ? `Resultat: ${match.homeGoals} - ${match.awayGoals}` : ''}
  </div>

  ${isLocked ? '<div class="text-red-500 text-sm mt-1 font-semibold">L친st</div>' : ''}
`;


      kampeContainer.appendChild(kampDiv);
    });

    totalPointsEl.textContent = `Samlet antal point: ${totalPoints}`;
  }

  // ===== Gem alle g칝t-knap =====
  document.getElementById("save-all").addEventListener("click", async () => {
    const kampDivs = document.querySelectorAll('.kamp');
    const batch = [];

    kampDivs.forEach((kampDiv) => {
      const matchId = kampDiv.dataset.matchId;
      const homeInput = kampDiv.querySelector('.homeGoals');
      const awayInput = kampDiv.querySelector('.awayGoals');

      if (!homeInput.disabled && !awayInput.disabled) {
        batch.push(
          db.collection("users")
            .doc(currentUser.uid)
            .collection("guesses")
            .doc(matchId)
            .set({
              homeGoals: Number(homeInput.value),
              awayGoals: Number(awayInput.value),
              savedAt: new Date()
            })
        );
      }
    });

    await Promise.all(batch);

    const notice = document.getElementById("save-notice");
    notice.textContent = "Alle g칝t er gemt!";
    notice.classList.remove("hidden");
    setTimeout(() => notice.classList.add("hidden"), 2000);
  });

  // ===== Admin: Importer kampe =====
  async function importMatches() {
    const matches = [
      {
        id: "match1",
        homeTeam: "Danmark",
        awayTeam: "Tyskland",
        homeFlag: "danmark.png",
        awayFlag: "tyskland.png",
        date: "2025-12-11",
        time: "18:00",
        homeGoals: null,
        awayGoals: null
      },
      {
        id: "match2",
        homeTeam: "Frankrig",
        awayTeam: "Norge",
        homeFlag: "frankrig.png",
        awayFlag: "norge.png",
        date: "2025-12-11",
        time: "19:00",
        homeGoals: null,
        awayGoals: null
      },
      {
        id: "match3",
        homeTeam: "Kroatien",
        awayTeam: "Japan",
        homeFlag: "kroatien.png",
        awayFlag: "japan.png",
        date: "2025-12-11",
        time: "20:00",
        homeGoals: null,
        awayGoals: null
      },
      {
        id: "match4",
        homeTeam: "Frankrig",
        awayTeam: "Japan",
        homeFlag: "frankrig.png",
        awayFlag: "japan.png",
        date: "2025-12-11",
        time: "20:30",
        homeGoals: null,
        awayGoals: null
      },
      {
        id: "match5",
        homeTeam: "England",
        awayTeam: "Portugal",
        homeFlag: "england.png",
        awayFlag: "portugal.png",
        date: "2025-12-11",
        time: "21:00",
        homeGoals: null,
        awayGoals: null
      },
      // ... forts칝t med alle kampe
    ];

    for (const match of matches) {
      await db.collection("matches").doc(match.id).set(match);
    }

    const notice = document.getElementById("save-notice");
    notice.textContent = "Alle kampe er importeret!";
    notice.classList.remove("hidden");
    setTimeout(() => notice.classList.add("hidden"), 2000);
  }

</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover {
  text-decoration: underline;
}
</style>

</body>
</html>
