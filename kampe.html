<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>G√¶t p√• kampene</title>
<link rel="stylesheet" href="styles.css">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-6 text-center">G√¶t p√• kampene</h1>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>
  <div id="save-notice" class="text-center text-white bg-green-600 rounded px-3 py-1 mb-4 hidden"></div>

<!-- ADMIN: Importer kampe -->
<button id="import-btn" onclick="importMatches()" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">
  Importer alle kampe til Firestore
</button>

<button id="save-all-guesses" 
        class="bg-blue-700 text-white px-4 py-2 rounded mb-4 hover:bg-blue-800">
  Gem alle g√¶t
</button>

  <div id="kampe-container" class="space-y-4"></div>

  <div id="total-points" class="text-xl font-semibold text-center mt-6"></div>
</main>

<script>
  // ======================
  // Firebase setup
  // ======================
  const firebaseConfig = {
    apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
    authDomain: "trampestips.firebaseapp.com",
    projectId: "trampestips",
    storageBucket: "trampestips.firebasestorage.app",
    messagingSenderId: "759235788489",
    appId: "1:759235788489:web:9515bc438a7c7d68469718",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const ADMIN_EMAIL = "p.h.trampedach@gmail.com";
  const kampeContainer = document.getElementById("kampe-container");
  const totalPointsEl = document.getElementById("total-points");
  let currentUser = null;

  // Lokale flag-stier
  const flags = {
    "Danmark": "Billeder/danmark.png",
    "Tyskland": "Billeder/tyskland.png",
    "England": "Billeder/england.png",
    "Frankrig": "Billeder/frankrig.png",
    "Japan": "Billeder/japan.png",
    "Kroatien": "Billeder/kroatien.png",
    "Norge": "Billeder/norge.png",
    "Portugal": "Billeder/portugal.png",
    // ... forts√¶t med alle 64 flag
  };

auth.onAuthStateChanged(async (user) => { 
  if (!user) {
    window.location.href = "gaet_login.html";
    return;
  }
  
  currentUser = user;
  document.getElementById("user-info").textContent = "Logget ind som: " + user.email;
  
  // üîπ Skjul import-knap for alle andre end admin
  if (currentUser.email !== ADMIN_EMAIL) {
    document.getElementById("import-btn").style.display = "none";
  }
  
  await loadKampe();
});

  async function loadKampe() {
    kampeContainer.innerHTML = `<p class="text-center text-gray-500">Indl√¶ser kampe...</p>`;
    const matchesSnap = await db.collection("matches").orderBy("date").get();
    const guessesSnap = await db.collection("users").doc(currentUser.uid).collection("guesses").get();
    const guesses = {};
    guessesSnap.forEach(doc => guesses[doc.id] = doc.data());
    kampeContainer.innerHTML = "";

    let totalPoints = 0;

    matchesSnap.forEach(doc => {
      const match = { id: doc.id, ...doc.data() };
      const userGuess = guesses[match.id] || {};
      const [day, month] = match.date.split("/").map(Number);
      const [hour, minute] = match.time.split(":").map(Number);
      const matchDateTime = new Date(match.dateTime); // match.dateTime = "2025-11-21T18:00"
      const now = new Date();
      const isLocked = now >= new Date(matchDateTime.getTime() - 60*60*1000);


      let points = 0;
      if (match.homeGoals != null && match.awayGoals != null && userGuess.homeGoals != null && userGuess.awayGoals != null) {
        const correctOutcome = match.homeGoals === match.awayGoals
          ? "draw" : match.homeGoals > match.awayGoals ? "home" : "away";
        const userOutcome = userGuess.homeGoals === userGuess.awayGoals
          ? "draw" : userGuess.homeGoals > userGuess.awayGoals ? "home" : "away";
        if (correctOutcome === userOutcome) points += 1;
        if (match.homeGoals === userGuess.homeGoals && match.awayGoals === userGuess.awayGoals) points += 2;
        totalPoints += points;
      }

      const kampDiv = document.createElement("div");
      kampDiv.setAttribute("data-match-id", match.id);

      let colorClass = "bg-white"; // standard hvis ingen point

if (match.homeGoals != null && match.awayGoals != null && userGuess.homeGoals != null && userGuess.awayGoals != null) {
    if (points === 3) {
        colorClass = "bg-green-400"; // pr√¶cis
    } else if (points === 1) {
        colorClass = "bg-blue-400"; // korrekt resultat
    } else {
        colorClass = "bg-red-400"; // forkert
    }
}

kampDiv.className = `p-3 rounded-lg border border-gray-300 shadow-md ${colorClass}`;

      kampDiv.innerHTML = `
  <div class="flex items-center justify-center gap-6">
    <!-- Venstre side -->
    <div class="flex items-center gap-2">
      <img src="${flags[match.homeTeam]}" class="w-8 h-8">
      <span class="font-semibold">${match.homeTeam}</span>
      <input type="number" min="0" class="homeGoals border rounded w-12 text-center" value="${userGuess.homeGoals ?? ''}" ${isLocked ? 'disabled' : ''}>
    </div>

    <!-- VS midten -->
    <div class="font-bold text-xl mx-4">vs</div>

    <!-- H√∏jre side -->
    <div class="flex items-center gap-2">
      <input type="number" min="0" class="awayGoals border rounded w-12 text-center" value="${userGuess.awayGoals ?? ''}" ${isLocked ? 'disabled' : ''}>
      <span class="font-semibold">${match.awayTeam}</span>
      <img src="${flags[match.awayTeam]}" class="w-8 h-8">
    </div>

    <!-- Kampdato/tid -->
    <div class="text-sm text-gray-500 ml-4">${match.date} ${match.time}</div>
  </div>

  <!-- Resultat under -->
  <div class="mt-2 text-sm text-gray-700">
    ${match.homeGoals != null ? `Resultat: ${match.homeGoals} - ${match.awayGoals}` : ''}
  </div>

  ${isLocked ? '<div class="text-red-500 text-sm mt-1 font-semibold">L√•st</div>' : ''}


        ${currentUser.email === ADMIN_EMAIL ? `
          <div class="mt-3 border-t pt-2">
            <h3 class="font-semibold text-sm mb-1 text-gray-600">Admin - indtast resultat</h3>
            <input type="number" class="adminHome border rounded w-12 text-center" placeholder="H" value="${match.homeGoals ?? ''}">
            <span>-</span>
            <input type="number" class="adminAway border rounded w-12 text-center" placeholder="U" value="${match.awayGoals ?? ''}">
            <button class="saveResult bg-green-600 text-white rounded px-3 py-1 hover:bg-green-700">Gem resultat</button>
          </div>` : ""}
      `;
      kampeContainer.appendChild(kampDiv);


      
    // GEM ALLE G√ÜT P√Ö √âN GANG
document.getElementById("save-all-guesses").addEventListener("click", async () => {

  const batch = db.batch(); // Batch-start

  const allMatchDivs = document.querySelectorAll("[data-match-id]");

  for (const div of allMatchDivs) {
    const matchId = div.getAttribute("data-match-id");
    const homeInput = kampDiv.querySelector(".homeGoals");
    const awayInput = kampDiv.querySelector(".awayGoals");
homeInput.disabled = isLocked;
awayInput.disabled = isLocked;


    // Spring l√•ste kampe over
    if (homeInput.disabled || awayInput.disabled) continue;

    const homeGoals = Number(homeInput.value);
    const awayGoals = Number(awayInput.value);

    const ref = db.collection("users")
                  .doc(currentUser.uid)
                  .collection("guesses")
                  .doc(matchId);

    batch.set(ref, {
      homeGoals,
      awayGoals,
      savedAt: new Date()
    });
  }

  // Udf√∏r alt i √©n realtime foresp√∏rgsel
  await batch.commit();

  const notice = document.getElementById("save-notice");
notice.textContent = "Alle g√¶t er gemt!";
notice.classList.remove("hidden");

// Fjern notifikationen efter 5 sekunder
setTimeout(() => {
  notice.classList.add("hidden");
}, 5000);

loadKampe(); // Opdater point
});


      // Gem resultat (admin)
      const resultBtn = kampDiv.querySelector(".saveResult");
      if (resultBtn) {
        resultBtn.addEventListener("click", async () => {
          const adminHome = kampDiv.querySelector(".adminHome").value;
          const adminAway = kampDiv.querySelector(".adminAway").value;
          await db.collection("matches").doc(match.id)
            .update({ homeGoals: Number(adminHome), awayGoals: Number(adminAway) });
          alert("Resultat gemt!");
          loadKampe(); // opdater point for alle brugere
        });
      }
    });

    totalPointsEl.textContent = `Samlet antal point: ${totalPoints}`;
  }
  async function importMatches() {
  // Firestore reference
  const db = firebase.firestore();

  // ‚≠ê Her skriver du alle dine kampe ind:
  const matches = [
    {
      id: "match1",
      homeTeam: "Danmark",
      awayTeam: "Tyskland",
      homeFlag: "danmark.png",
      awayFlag: "tyskland.png",
      date: "2025-17-12",
      time: "17:00",
      homeGoals: null,
      awayGoals: null
    },
    {
      id: "match2",
      homeTeam: "Frankrig",
      awayTeam: "Norge",
      homeFlag: "frankrig.png",
      awayFlag: "norge.png",
      date: "2025-11-12",
      time: "18:00",
      homeGoals: null,
      awayGoals: null
    },
    {
      id: "match3",
      homeTeam: "Kroatien",
      awayTeam: "Japan",
      homeFlag: "kroatien.png",
      awayFlag: "Japan.png",
      date: "2025-11-12",
      time: "19:00",
      homeGoals: null,
      awayGoals: null
    },
    {
      id: "match4",
      homeTeam: "England",
      awayTeam: "Portugal",
      homeFlag: "england.png",
      awayFlag: "portugal.png",
      date: "2025-12-11",
      time: "21:00",
      homeGoals: null,
      awayGoals: null
    },
    // ... forts√¶t med dine 10 kampe
  ];

  for (const match of matches) {
    await db.collection("matches").doc(match.id).set(match);
  }

  alert("Alle kampe er importeret til Firestore!");
}
</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover {
  text-decoration: underline;
}
</style>

</body>
</html>
