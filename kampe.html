<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gæt på kampene</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-6 text-center">Gæt på kampene</h1>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>

  <!-- KAMPE -->
  <div id="kampe-container" class="space-y-4"></div>

  <!-- TOTAL POINT -->
  <div id="total-points" class="text-xl font-semibold text-center mt-6"></div>
</main>

<script>
/* ===================================
   Firebase Setup
=================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "P.H.Trampedach@gmail.com";

let currentUser = null;
const kampeContainer = document.getElementById("kampe-container");
const totalPointsEl = document.getElementById("total-points");

/* ===================================
   Auth Check
=================================== */
auth.onAuthStateChanged(async (user) => {
  if (!user) return (window.location.href = "gaet.html");
  
  currentUser = user;
  document.getElementById("user-info").textContent = "Logget ind som: " + user.email;

  loadKampe();
});

/* ===================================
   Load Matches + User Guesses
=================================== */
async function loadKampe() {
  kampeContainer.innerHTML = `<p class="text-center text-gray-500">Indlæser kampe...</p>`;

  const matchesSnap = await db.collection("matches").orderBy("date").get();
  const guessesSnap = await db.collection("users").doc(currentUser.uid)
    .collection("guesses").get();

  let userGuesses = {};
  guessesSnap.forEach(doc => userGuesses[doc.id] = doc.data());

  kampeContainer.innerHTML = "";
  let totalPoints = 0;

  /* ===================================
     Byg hver kamp
  =================================== */
  matchesSnap.forEach((doc) => {
    const match = { id: doc.id, ...doc.data() };
    const guess = userGuesses[match.id] || {};

    /* Låst 1 time før kampstart */
    const matchStart = new Date(match.date + "T" + match.time);
    const now = new Date();
    const locked = now > new Date(matchStart.getTime() - 3600000);

    /* Pointberegning */
    let points = 0;
    if (match.homeGoals != null && match.awayGoals != null &&
        guess.homeGoals != null && guess.awayGoals != null) {

      const matchOutcome = match.homeGoals === match.awayGoals ? "draw" :
                           match.homeGoals > match.awayGoals ? "home" : "away";

      const guessOutcome = guess.homeGoals === guess.awayGoals ? "draw" :
                           guess.homeGoals > guess.awayGoals ? "home" : "away";

      if (matchOutcome === guessOutcome) points += 1;
      if (match.homeGoals === guess.homeGoals &&
          match.awayGoals === guess.awayGoals) points += 2;
    }
    totalPoints += points;

    /* HTML til kampkort */
    const kamp = document.createElement("div");
    kamp.className = "p-4 rounded-lg border shadow-sm bg-gray-50";

    kamp.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="${match.homeFlag}" class="w-8 h-8">
          <span class="font-semibold">${match.homeTeam}</span>

          <span class="text-lg font-bold mx-2">vs</span>

          <img src="${match.awayFlag}" class="w-8 h-8">
          <span class="font-semibold">${match.awayTeam}</span>
        </div>

        <div class="text-sm text-gray-500">${match.date} ${match.time}</div>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <input type="number" min="0" class="homeGoals border rounded w-12 text-center"
               value="${guess.homeGoals ?? ''}" ${locked ? "disabled" : ""}>
        <span>-</span>
        <input type="number" min="0" class="awayGoals border rounded w-12 text-center"
               value="${guess.awayGoals ?? ''}" ${locked ? "disabled" : ""}>

        <button class="saveGuess bg-blue-600 text-white rounded px-3 py-1 ${
          locked ? "opacity-50 cursor-not-allowed" : "hover:bg-blue-700"
        }" ${locked ? "disabled" : ""}>Gem</button>

        ${locked ? `<span class="text-red-500 text-sm ml-2">Låst</span>` : ""}
      </div>

      <div class="mt-2 text-sm text-gray-700">
        ${match.homeGoals != null ? `Resultat: ${match.homeGoals} - ${match.awayGoals}` : ""}
      </div>

      <div class="mt-2 font-semibold">Point: ${points}</div>

      ${
        currentUser.email === ADMIN_EMAIL
          ? `
      <div class="mt-3 border-t pt-2">
        <h3 class="font-semibold text-sm text-gray-600">Admin – Indtast resultat</h3>
        <input type="number" class="adminHome border rounded w-12 text-center" value="${match.homeGoals ?? ''}">
        <span>-</span>
        <input type="number" class="adminAway border rounded w-12 text-center" value="${match.awayGoals ?? ''}">
        <button class="saveResult bg-green-600 text-white rounded px-3 py-1 hover:bg-green-700">
          Gem resultat
        </button>
      </div>
      `
          : ""
      }
    `;

    /* Tilføj til DOM */
    kampeContainer.appendChild(kamp);

    /* ========================
       Gem gæt (ikke låst)
    ======================== */
    const guessBtn = kamp.querySelector(".saveGuess");
    if (guessBtn && !locked) {
      guessBtn.addEventListener("click", async () => {
        const h = Number(kamp.querySelector(".homeGoals").value);
        const a = Number(kamp.querySelector(".awayGoals").value);

        await db.collection("users")
          .doc(currentUser.uid)
          .collection("guesses")
          .doc(match.id)
          .set({ homeGoals: h, awayGoals: a, savedAt: new Date() });

        alert("Dit gæt er gemt!");
      });
    }

    /* ========================
       ADMIN – Gem resultat
    ======================== */
    const resultBtn = kamp.querySelector(".saveResult");
    if (resultBtn) {
      resultBtn.addEventListener("click", async () => {
        const h = Number(kamp.querySelector(".adminHome").value);
        const a = Number(kamp.querySelector(".adminAway").value);

        await db.collection("matches")
          .doc(match.id)
          .update({ homeGoals: h, awayGoals: a });

        alert("Resultat gemt!");
        loadKampe();
      });
    }
  });

  /* Vis total point */
  totalPointsEl.textContent = `Samlet antal point: ${totalPoints}`;
}
</script>

<style>
  .menu-bar {
    display: flex;
    justify-content: center;
    background-color: #007bff;
    padding: 10px;
    gap: 15px;
  }
  .menu-bar a {
    color: white;
    font-weight: bold;
    text-decoration: none;
  }
  .menu-bar a:hover {
    text-decoration: underline;
  }
</style>

</body>
</html>
