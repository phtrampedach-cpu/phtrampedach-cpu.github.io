<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gæt på kampene</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="1Forside.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="2Contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-4 text-center">Gæt på kampene</h1>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>

  <div class="flex justify-center gap-3 mb-4" id="tournament-selector">
    <button data-tournament="VM2026" class="tournament-btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">VM 2026</button>
    <button data-tournament="Superliga" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Superliga Forår 2026</button>
    <button data-tournament="PremierLeague" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Premier League Forår 2026</button>
  </div>

  <div class="flex justify-center gap-3 mb-4" id="controls-container">
    <!-- Gem alle gæt -->
    <button id="save-all" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gem alle gæt</button>

    <!-- Admin: Importer kamp -->
    <button id="import-btn" onclick="importMatches()" style="display:none;" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Importer alle kampe</button>
  </div>

  <div id="save-notice" class="hidden text-green-700 font-semibold mb-2 text-center"></div>

  <div id="total-points" class="text-xl font-semibold text-center mb-4"></div>

  <div id="kampe-container" class="space-y-4"></div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "p.h.trampedach@gmail.com";
const kampeContainer = document.getElementById("kampe-container");
const totalPointsEl = document.getElementById("total-points");
let currentUser = null;
let selectedTournament = "VM2026";

const flags = {
  "Danmark":"Billeder/danmark.png",
  "Tyskland":"Billeder/tyskland.png",
  "England":"Billeder/england.png",
  "Frankrig":"Billeder/frankrig.png",
  "Japan":"Billeder/japan.png",
  "Kroatien":"Billeder/kroatien.png",
  "Norge":"Billeder/norge.png",
  "Portugal":"Billeder/portugal.png",
  "FCK":"Billeder/fck.png",
  "FC Midtjylland":"Billeder/fcm.png",
  "Manchester United":"Billeder/manu.png",
  "Chelsea":"Billeder/chelsea.png",
};

// ===== Check login =====
auth.onAuthStateChanged(async (user) => {
  if (!user) { window.location.href = "gaet_login.html"; return; }
  currentUser = user;

  const userRef = db.collection("users").doc(user.uid);
  const userSnap = await userRef.get();

  if (!userSnap.exists || !userSnap.data().username) {
    window.location.href = "choose_username.html";
    return;
  }

  const username = userSnap.data().username;
  document.getElementById("user-info").textContent = `Logget ind som: ${username}`;

  // Kun admin kan se import-knappen
  if (currentUser.email === ADMIN_EMAIL) {
    document.getElementById("import-btn").style.display = "inline-block";
  }

  await loadKampe();
});

// ===== Turnering valg =====
document.querySelectorAll('.tournament-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    selectedTournament = btn.dataset.tournament;

    document.querySelectorAll('.tournament-btn').forEach(b => {
      if(b===btn){
        b.classList.remove('bg-gray-300','text-gray-800');
        b.classList.add('bg-blue-600','text-white');
      } else {
        b.classList.remove('bg-blue-600','text-white');
        b.classList.add('bg-gray-300','text-gray-800');
      }
    });

    await loadKampe();
  });
});

// ===== Load kampe =====
async function loadKampe() {
  kampeContainer.innerHTML = `<p class="text-center text-gray-500">Indlæser kampe...</p>`;
  const matchesSnap = await db.collection("matches")
                              .where("tournament","==",selectedTournament)
                              .orderBy("date").get();
  const guessesSnap = await db.collection("users")
                              .doc(currentUser.uid)
                              .collection("guesses").get();

  const guesses = {};
  guessesSnap.forEach(doc => guesses[doc.id] = doc.data());
  kampeContainer.innerHTML = "";

  let totalPoints = 0;

  matchesSnap.forEach(doc => {
    const match = {id: doc.id, ...doc.data()};
    const userGuess = guesses[match.id] || {};

    const [year,month,day] = match.date.split("-").map(Number);
    const [hour,minute] = match.time.split(":").map(Number);
    const matchDateTime = new Date(year,month-1,day,hour,minute);
    const now = new Date();
    const isLocked = now > new Date(matchDateTime.getTime() - 60*60*1000);

    // Beregn point
    let points=0;
    if(match.homeGoals!=null && match.awayGoals!=null && userGuess.homeGoals!=null && userGuess.awayGoals!=null){
      const correctOutcome = match.homeGoals===match.awayGoals?"draw":match.homeGoals>match.awayGoals?"home":"away";
      const userOutcome = userGuess.homeGoals===userGuess.awayGoals?"draw":userGuess.homeGoals>userGuess.awayGoals?"home":"away";
      if(correctOutcome===userOutcome) points+=1;
      if(match.homeGoals===userGuess.homeGoals && match.awayGoals===userGuess.awayGoals) points+=2;
      totalPoints+=points;
    }

    let homeColor="", awayColor="";
    if(match.homeGoals!=null && match.awayGoals!=null && userGuess.homeGoals!=null && userGuess.awayGoals!=null){
      if(points===3){homeColor=awayColor="bg-green-500"}
      else if(points===1){homeColor=awayColor="bg-green-300"}
      else{homeColor=awayColor="bg-red-500"}
    }

    const kampDiv=document.createElement("div");
    kampDiv.className="p-3 rounded-lg border border-gray-300 shadow-md kamp";
    kampDiv.dataset.matchId=match.id;
    kampDiv.innerHTML=`
      <div class="flex items-center justify-between gap-4">
        <img src="${flags[match.homeTeam]}" class="w-8 h-8">
        <span class="font-semibold">${match.homeTeam}</span>
        <input type="number" min="0" class="homeGoals border rounded w-12 text-center ${homeColor}" value="${userGuess.homeGoals??''}" ${isLocked?'disabled':''}>

        <span class="font-bold text-xl">vs</span>

        <input type="number" min="0" class="awayGoals border rounded w-12 text-center ${awayColor}" value="${userGuess.awayGoals??''}" ${isLocked?'disabled':''}>
        <span class="font-semibold">${match.awayTeam}</span>
        <img src="${flags[match.awayTeam]}" class="w-8 h-8">

        <span class="text-sm text-gray-500 ml-4">${match.date} ${match.time}</span>
      </div>

      <div class="mt-2 text-sm text-gray-700">
        ${match.homeGoals!=null?`Resultat: ${match.homeGoals} - ${match.awayGoals}`:''}
      </div>

      ${isLocked?'<div class="text-red-500 text-sm mt-1 font-semibold">Låst</div>':''}
    `;

    kampeContainer.appendChild(kampDiv);
  });

  totalPointsEl.textContent=`Samlet antal point (${selectedTournament}): ${totalPoints}`;
}

// ===== Gem alle gæt =====
document.getElementById("save-all").addEventListener("click", async ()=>{
  const kampDivs=document.querySelectorAll('.kamp');
  const batch=[];
  kampDivs.forEach(kampDiv=>{
    const matchId=kampDiv.dataset.matchId;
    const homeInput=kampDiv.querySelector('.homeGoals');
    const awayInput=kampDiv.querySelector('.awayGoals');
    if(!homeInput.disabled && !awayInput.disabled){
      batch.push(
        db.collection("users").doc(currentUser.uid)
          .collection("guesses").doc(matchId)
          .set({
            homeGoals:Number(homeInput.value),
            awayGoals:Number(awayInput.value),
            savedAt:new Date()
          })
      );
    }
  });

  await Promise.all(batch);

  const notice=document.getElementById("save-notice");
  notice.textContent="Alle gæt er gemt!";
  notice.classList.remove("hidden");
  setTimeout(()=>notice.classList.add("hidden"),2000);
});

// ===== Import kampene (opdelt) =====
async function importMatches(){
  const vmMatches=[
    {id:"VM1", tournament:"VM2026", 
    homeTeam:"Danmark", awayTeam:"Tyskland", 
    homeFlag:"danmark.png", awayFlag:"tyskland.png", 
    date:"2025-12-16", time:"18:00", 
    homeGoals:null, awayGoals:null},
    
    {id:"VM2", tournament:"VM2026", 
    homeTeam:"Frankrig", awayTeam:"Norge", 
    homeFlag:"frankrig.png", awayFlag:"norge.png", 
    date:"2025-12-16", time:"19:00", 
    homeGoals:null, awayGoals:null},
    
    {id:"VM3", tournament:"VM2026", 
    homeTeam:"Kroatien", awayTeam:"Japan", 
    homeFlag:"kroatien.png", awayFlag:"japan.png", 
    date:"2025-12-16", time:"20:00", 
    homeGoals:null, awayGoals:null},
    
    {id:"VM4", tournament:"VM2026", 
    homeTeam:"Frankrig", awayTeam:"Japan", 
    homeFlag:"frankrig.png", awayFlag:"japan.png", 
    date:"2025-12-18", time:"20:30", 
    homeGoals:null, awayGoals:null},
    
    {id:"VM5", tournament:"VM2026", 
    homeTeam:"England", awayTeam:"Portugal", 
    homeFlag:"england.png", awayFlag:"portugal.png", 
    date:"2025-12-18", time:"21:00", 
    homeGoals:null, awayGoals:null},
  ];

  const superligaMatches=[
    {id:"SL1", tournament:"Superliga", 
    homeTeam:"FC Midtjylland", awayTeam:"FCK", 
    homeFlag:"fcm.png", awayFlag:"fck.png", 
    date:"2026-02-08", time:"16:00", 
    homeGoals:null, awayGoals:null},

    {id:"SL2", tournament:"Superliga", 
    homeTeam:"FCK", awayTeam:"FCN", 
    homeFlag:"fck.png", awayFlag:"fcn.png", 
    date:"2026-02-14", time:"17:00", 
    homeGoals:null, awayGoals:null},

    {id:"SL3", tournament:"Superliga", 
    homeTeam:"OB", awayTeam:"FCK", 
    homeFlag:"ob.png", awayFlag:"fck.png", 
    date:"2026-02-21", time:"14:00", 
    homeGoals:null, awayGoals:null},

    {id:"SL4", tournament:"Superliga", 
    homeTeam:"FCK", awayTeam:"Randers FC", 
    homeFlag:"fck.png", awayFlag:"rfc.png", 
    date:"2026-03-01", time:"17:00", 
    homeGoals:null, awayGoals:null}
  ];

  const premierLeagueMatches=[
    {id:"PL1", tournament:"PremierLeague", 
    homeTeam:"Arsenal", awayTeam:"Manchester United", 
    homeFlag:"arsenal.png", awayFlag:"manu.png", 
    date:"2026-01-25", time:"17:30", 
    homeGoals:null, awayGoals:null},

    {id:"PL2", tournament:"PremierLeague", 
    homeTeam:"Manchester United", awayTeam:"Fulham", 
    homeFlag:"manu.png", awayFlag:"fulham.png", 
    date:"2026-02-01", time:"15:00", 
    homeGoals:null, awayGoals:null}
  ];

  const allMatches=[...vmMatches,...superligaMatches,...premierLeagueMatches];

  for(const match of allMatches){
    await db.collection("matches").doc(match.id).set(match);
  }

  const notice=document.getElementById("save-notice");
  notice.textContent=`Alle ${allMatches.length} kampe er importeret!`;
  notice.classList.remove("hidden");
  setTimeout(()=>notice.classList.add("hidden"),2000);
}
</script>

<style>
.menu-bar {
  display: flex;
  justify-content: center;
  background-color: #007bff;
  padding: 10px;
  gap: 15px;
}
.menu-bar a {
  color: white;
  font-weight: bold;
  text-decoration: none;
}
.menu-bar a:hover, .menu-bar a.active {
  text-decoration: underline;
}
</style>

<script>
function calculatePoints(guess, match) {
  const exact =
    guess.homeGoals === match.homeGoals &&
    guess.awayGoals === match.awayGoals;

  const outcome =
    (match.homeGoals > match.awayGoals && guess.homeGoals > guess.awayGoals) ||
    (match.homeGoals < match.awayGoals && guess.homeGoals < guess.awayGoals) ||
    (match.homeGoals === match.awayGoals && guess.homeGoals === guess.awayGoals);

  if (exact) {
    return { points: 3, exact: 1, outcome: 0 };
  }

  if (outcome) {
    return { points: 1, exact: 0, outcome: 1 };
  }

  return { points: 0, exact: 0, outcome: 0 };
}
</script>

<script>
async function updateLeaderboardForMatch(matchId) {
  const matchSnap = await db.collection("matches").doc(matchId).get();
  if (!matchSnap.exists) return;

  const match = matchSnap.data();
  const tournament = match.tournament;

  if (match.homeGoals === null || match.awayGoals === null) return;

  const guessesSnap = await db.collection("guesses").get();

  for (const userDoc of guessesSnap.docs) {
    const userId = userDoc.id;
    const guess = userDoc.data()[matchId];
    if (!guess) continue;

    const result = calculatePoints(guess, match);

    if (result.points === 0) continue;

    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();
    if (!userSnap.exists) continue;

    const username = userSnap.data().username;

    const lbRef = db
      .collection("leaderboards")
      .doc(tournament)
      .collection("users")
      .doc(userId);

    await lbRef.set(
      {
        username,
        points: firebase.firestore.FieldValue.increment(result.points),
        correctResult: firebase.firestore.FieldValue.increment(result.exact),
        correctOutcome: firebase.firestore.FieldValue.increment(result.outcome),
      },
      { merge: true }
    );
  }
}


async function updateLeaderboardForUser(matchId, guess) {
  const matchSnap = await db.collection("matches").doc(matchId).get();
  if (!matchSnap.exists) return;

  const match = matchSnap.data();

  // Kampen er ikke færdig
  if (match.homeGoals === null || match.awayGoals === null) return;
  if (!match.tournament) return;

  const gDiff = guess.homeGoals - guess.awayGoals;
  const mDiff = match.homeGoals - match.awayGoals;

  let points = 0;
  let correctResult = 0;
  let correctOutcome = 0;

  if (
    guess.homeGoals === match.homeGoals &&
    guess.awayGoals === match.awayGoals
  ) {
    points = 3;
    correctResult = 1;
  } else if (
    (gDiff > 0 && mDiff > 0) ||
    (gDiff === 0 && mDiff === 0) ||
    (gDiff < 0 && mDiff < 0)
  ) {
    points = 1;
    correctOutcome = 1;
  }

  if (points === 0) return;

  const userSnap = await db.collection("users").doc(auth.currentUser.uid).get();
  if (!userSnap.exists) return;

  const username = userSnap.data().username ?? "Ukendt";

  await db
    .collection("leaderboards")
    .doc(match.tournament)
    .collection("users")
    .doc(auth.currentUser.uid)
    .set({
      username,
      points: firebase.firestore.FieldValue.increment(points),
      correctResult: firebase.firestore.FieldValue.increment(correctResult),
      correctOutcome: firebase.firestore.FieldValue.increment(correctOutcome),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
}
</script></0>


</body>
</html>
