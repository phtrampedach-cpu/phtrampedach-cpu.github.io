<!doctype html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>G√¶t p√• kampene</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<header>
  <nav class="menu-bar">
    <a href="index.html">Forside</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="2Contact.html">Kontakt</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto bg-white mt-8 p-6 rounded-lg shadow">
  <h1 class="text-3xl font-bold mb-4 text-center">G√¶t p√• kampene</h1>

  <p id="user-info" class="text-center text-gray-600 mb-4"></p>

  <div class="flex justify-center gap-3 mb-4" id="tournament-selector">
    <button data-tournament="VM2026" class="tournament-btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">VM 2026</button>
    <button data-tournament="Superliga" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Superliga For√•r 2026</button>
    <button data-tournament="PremierLeague" class="tournament-btn bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Premier League For√•r 2026</button>
  </div>

  <div class="flex justify-center gap-3 mb-4" id="controls-container">
    <!-- Gem alle g√¶t -->
    <button id="save-all" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Gem alle g√¶t</button>

    <!-- Admin: Importer kamp -->
    <button id="import-btn" onclick="importMatches()" style="display:none;" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Importer alle kampe</button>
  </div>

  <div id="save-notice" class="hidden text-green-700 font-semibold mb-2 text-center"></div>

  <div id="total-points" class="text-xl font-semibold text-center mb-4"></div>

  <div id="kampe-container" class="space-y-4"></div>
</main>

<script>
/* ===============================
   FIREBASE INIT
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBQBoHOBENQHP20J7pv1kkEs2gTd7r_flg",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

/* ===============================
   AUTH CHECK
================================ */
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "gaet_login.html";
    return;
  }
  currentUser = user;
  loadKampe(); // eksisterende funktion
});

/* ===============================
   POINTBEREGNING (BRUGES FLERE STEDER)
================================ */
function calculatePoints(guess, match) {
  let points = 0;
  let exact = 0;
  let outcome = 0;

  const gDiff = guess.homeGoals - guess.awayGoals;
  const mDiff = match.homeGoals - match.awayGoals;

  if (guess.homeGoals === match.homeGoals &&
      guess.awayGoals === match.awayGoals) {
    points = 3;
    exact = 1;
  } else if (
    (gDiff > 0 && mDiff > 0) ||
    (gDiff === 0 && mDiff === 0) ||
    (gDiff < 0 && mDiff < 0)
  ) {
    points = 1;
    outcome = 1;
  }

  return { points, exact, outcome };
}

/* ===============================
   üî• OPDATER LEADERBOARD (NY)
================================ */
async function updateLeaderboardForUser(matchId, guess) {
  const matchSnap = await db.collection("matches").doc(matchId).get();
  if (!matchSnap.exists) return;

  const match = matchSnap.data();

  // Ingen point hvis kampen ikke er spillet
  if (match.homeGoals === null || match.awayGoals === null) return;

  const result = calculatePoints(guess, match);
  if (result.points === 0) return;

  const userSnap = await db.collection("users").doc(currentUser.uid).get();
  if (!userSnap.exists) return;

  const username = userSnap.data().username;

  const lbRef = db
    .collection("leaderboards")
    .doc(match.tournament)
    .collection("users")
    .doc(currentUser.uid);

  await lbRef.set({
    username,
    points: firebase.firestore.FieldValue.increment(result.points),
    correctResult: firebase.firestore.FieldValue.increment(result.exact),
    correctOutcome: firebase.firestore.FieldValue.increment(result.outcome),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

/* ===============================
   GEM ALLE G√ÜT (RETTET)
================================ */
document.getElementById("save-all").addEventListener("click", async () => {
  const kampDivs = document.querySelectorAll(".kamp");

  for (const kampDiv of kampDivs) {
    const matchId = kampDiv.dataset.matchId;
    const homeInput = kampDiv.querySelector(".homeGoals");
    const awayInput = kampDiv.querySelector(".awayGoals");

    // L√•ste eller tomme inputs ignoreres
    if (homeInput.disabled || awayInput.disabled) continue;
    if (homeInput.value === "" || awayInput.value === "") continue;

    const guess = {
      homeGoals: Number(homeInput.value),
      awayGoals: Number(awayInput.value),
      savedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // 1Ô∏è‚É£ Gem g√¶t
    await db
      .collection("users")
      .doc(currentUser.uid)
      .collection("guesses")
      .doc(matchId)
      .set(guess);

    // 2Ô∏è‚É£ Opdater leaderboard automatisk
    await updateLeaderboardForUser(matchId, guess);
  }

  const notice = document.getElementById("save-notice");
  notice.textContent = "Alle g√¶t er gemt";
  notice.classList.remove("hidden");
  setTimeout(() => notice.classList.add("hidden"), 2000);
});


</script>




</body>
</html>
