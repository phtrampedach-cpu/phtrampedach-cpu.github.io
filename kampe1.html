<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ¦t pÃ¥ kampene</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<header class="bg-white shadow p-4 mb-6">
  <nav class="max-w-3xl mx-auto flex gap-4">
    <a href="index.html" class="text-blue-600 font-semibold">Forside</a>
    <a href="gaet.html" class="text-blue-600 font-semibold">Dashboard</a>
    <a href="contact.html" class="text-blue-600 font-semibold">Kontakt</a>
  </nav>
</header>

<main class="max-w-3xl mx-auto p-4">
  <h1 class="text-3xl font-bold mb-6">GÃ¦t pÃ¥ resultat</h1>
  <div id="content-area"></div>
  <p id="sum-points" class="font-bold mt-4"></p>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* =======================
   KONFIGURATION
======================= */
const pointsConfig = { exactScore:3, correctOutcome:1, wrong:0 };
const ADMIN_EMAIL = "P.H.Trampedach@gmail.com";

/* =======================
   FIREBASE INIT
======================= */
const firebaseConfig = { /* din Firebase config her */ };
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =======================
   KAMPE
======================= */
const kampe = [
  { id:"match1", hjemmehold: "Danmark", hjemmeFlag: "danmark.png", udehold: "Tyskland", udeFlag: "tyskland.png", dato: "20/11", tid: "18:00", start:"2025-11-20T18:00:00" },
  { id:"match2", hjemmehold: "Frankrig", hjemmeFlag: "france.png", udehold: "Italien", udeFlag: "italy.png", dato: "21/11", tid: "20:00", start:"2025-11-21T20:00:00" },
  { id:"match3", hjemmehold: "Spanien", hjemmeFlag: "spain.png", udehold: "Portugal", udeFlag: "portugal.png", dato: "22/11", tid: "18:00", start:"2025-11-22T18:00:00" }
];

let guesses = {};
let results = {};
let currentUserEmail = "";
let currentUserUid = "";
let isAdmin = false;

const contentArea = document.getElementById('content-area');

/* =======================
   HJÃ†LPEFUNKTIONER
======================= */
function outcome(h,a){
  h=parseInt(h,10); a=parseInt(a,10);
  if(isNaN(h)||isNaN(a)) return "";
  if(h>a) return "home";
  if(h<a) return "away";
  return "draw";
}

/* =======================
   RENDER KAMPKORT
======================= */
function renderKampe(){
  contentArea.innerHTML = "";
  const now = new Date();
  let totalPoints = 0;

  kampe.forEach((kamp,index)=>{
    const start = new Date(kamp.start);
    const cutoff = new Date(start.getTime() - 60*60*1000);
    const locked = now>cutoff;

    const g = guesses[kamp.id] || {homeGoals:"", awayGoals:""};
    const r = results[kamp.id] || {homeGoals:"", awayGoals:""};

    let pts="";
    if(r.homeGoals!=="" && r.awayGoals!=="" && g.homeGoals!=="" && g.awayGoals!==""){
      const resOutcome=outcome(r.homeGoals,r.awayGoals);
      const guessOutcome=outcome(g.homeGoals,g.awayGoals);
      if(r.homeGoals==g.homeGoals && r.awayGoals==g.awayGoals) pts=pointsConfig.exactScore;
      else if(resOutcome==guessOutcome) pts=pointsConfig.correctOutcome;
      else pts=pointsConfig.wrong;
      totalPoints+=pts;
    }

    const kampDiv = document.createElement('div');
    kampDiv.className = "bg-white shadow-md rounded-lg p-4 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4";

    kampDiv.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2"><img src="${kamp.hjemmeFlag}" alt="" class="w-8 h-8"><span class="font-semibold">${kamp.hjemmehold}</span></div>
        <span class="font-bold text-xl">vs</span>
        <div class="flex items-center gap-2"><img src="${kamp.udeFlag}" alt="" class="w-8 h-8"><span class="font-semibold">${kamp.udehold}</span></div>
      </div>

      <div class="flex gap-2">
        <input type="number" min="0" class="score-input w-12 text-center border rounded px-1" data-match="${kamp.id}" data-type="home" value="${g.homeGoals}" ${locked?"disabled":""}>
        -
        <input type="number" min="0" class="score-input w-12 text-center border rounded px-1" data-match="${kamp.id}" data-type="away" value="${g.awayGoals}" ${locked?"disabled":""}>
      </div>

      <div class="text-gray-500 text-sm">${kamp.dato} ${kamp.tid} ${locked?"ðŸ”’ Lukket":""}</div>

      <div class="font-bold">${pts!==""?pts+"p":""}</div>

      ${isAdmin?`<div class="flex gap-2 mt-2 md:mt-0">
        <input type="number" min="0" class="score-input w-12 text-center border rounded px-1 admin" data-match="${kamp.id}" data-type="rhome" value="${r.homeGoals}">
        -
        <input type="number" min="0" class="score-input w-12 text-center border rounded px-1 admin" data-match="${kamp.id}" data-type="raway" value="${r.awayGoals}">
      </div>`:""}
    `;

    contentArea.appendChild(kampDiv);
  });

  document.getElementById("sum-points").textContent = `Samlede point: ${totalPoints}`;
}

/* =======================
   GEM DATA
======================= */
async function gemGaet(){
  document.querySelectorAll(".score-input[data-match]").forEach(inp=>{
    const id=inp.dataset.match, t=inp.dataset.type;
    if(!guesses[id]) guesses[id]={};
    if(t==="home") guesses[id].homeGoals=inp.value;
    if(t==="away") guesses[id].awayGoals=inp.value;
  });

  const batch = db.batch();
  Object.keys(guesses).forEach(matchId=>{
    const ref = db.collection("users").doc(currentUserUid).collection("guesses").doc(matchId);
    batch.set(ref,{homeGoals:guesses[matchId].homeGoals, awayGoals:guesses[matchId].awayGoals, savedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  });
  await batch.commit();
}

async function gemResultater(){
  document.querySelectorAll(".score-input.admin").forEach(inp=>{
    const id=inp.dataset.match, t=inp.dataset.type;
    if(!results[id]) results[id]={};
    if(t==="rhome") results[id].homeGoals=inp.value;
    if(t==="raway") results[id].awayGoals=inp.value;
  });

  const batch = db.batch();
  Object.keys(results).forEach(matchId=>{
    const ref = db.collection("matches").doc(matchId);
    batch.set(ref,{homeGoals:results[matchId].homeGoals, awayGoals:results[matchId].awayGoals},{merge:true});
  });
  await batch.commit();
}

/* =======================
   INIT
======================= */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUserEmail=user.email;
    currentUserUid=user.uid;
    isAdmin = (currentUserEmail===ADMIN_EMAIL);

    // Hent tidligere gÃ¦t
    const guessSnap = await db.collection("users").doc(currentUserUid).collection("guesses").get();
    guessSnap.forEach(doc=>{guesses[doc.id]=doc.data();});

    // Hent resultater
    const resultSnap = await db.collection("matches").get();
    resultSnap.forEach(doc=>{results[doc.id]=doc.data();});

    renderKampe();

    const gemBtn = document.querySelector('#content-area + button') || (()=>{
      const b=document.createElement('button');
      b.className="mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded hover:bg-blue-700";
      b.textContent="Gem gÃ¦t";
      document.querySelector('main').appendChild(b);
      return b;
    })();

    gemBtn.addEventListener('click', async ()=>{
      if(isAdmin) await gemResultater();
      else await gemGaet();
      renderKampe();
      alert("GÃ¦t/resultater gemt!");
    });
  } else {
    window.location.href="login.html";
  }
});
</script>

</body>
</html>
