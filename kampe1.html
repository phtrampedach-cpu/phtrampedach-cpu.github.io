<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ¦t pÃ¥ kampene</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <nav class="menu-bar">
    <a href="1Forside.html">Forside</a>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="2Contact.html">Kontakt</a>
  </nav>
</header>

<main>
  <h1>GÃ¦t pÃ¥ resultat</h1>
  <p id="user-info"></p>

  <div id="content-area"></div>
  <p id="sum-points" class="font-bold mt-4"></p>

  <h2>Highscore</h2>
  <div id="highscore-container"></div>
</main>

<script>
/* =========================
   KONFIGURATION
========================= */
const pointsConfig = { exactScore:3, correctOutcome:1, wrong:0 };
const ADMIN_EMAIL = "P.H.Trampedach@gmail.com";

/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = { 
  apiKey: "xxx",
  authDomain: "trampestips.firebaseapp.com",
  projectId: "trampestips",
  storageBucket: "trampestips.firebasestorage.app",
  messagingSenderId: "759235788489",
  appId: "1:759235788489:web:9515bc438a7c7d68469718",
  measurementId: "G-B6YTNFRJPS"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   KAMPE
========================= */
const kampe = [
  { id:"match1", hjemmehold: "Danmark", hjemmeFlag: "danmark.png", udehold: "Tyskland", udeFlag: "tyskland.png", dato: "20/11", tid: "18:00", start:"2025-11-20T18:00:00" },
  { id:"match2", hjemmehold: "Frankrig", hjemmeFlag: "france.png", udehold: "Italien", udeFlag: "italy.png", dato: "21/11", tid: "20:00", start:"2025-11-21T20:00:00" },
  { id:"match3", hjemmehold: "Spanien", hjemmeFlag: "spain.png", udehold: "Portugal", udeFlag: "portugal.png", dato: "22/11", tid: "18:00", start:"2025-11-22T18:00:00" }
];

let guesses = {};
let results = {};
let currentUserEmail = "";
let currentUserUid = "";
let isAdmin = false;

/* =========================
   HJÃ†LPEFUNKTION
========================= */
function outcome(h,a){
  h=parseInt(h,10); a=parseInt(a,10);
  if(isNaN(h)||isNaN(a)) return "";
  if(h>a) return "home";
  if(h<a) return "away";
  return "draw";
}

/* =========================
   RENDER KAMPKORT
========================= */
function renderKampe(){
  const contentArea = document.getElementById("content-area");
  contentArea.innerHTML = "";
  const now = new Date();
  let totalPoints = 0;

  kampe.forEach((kamp)=>{
    const start = new Date(kamp.start);
    const cutoff = new Date(start.getTime() - 60*60*1000);
    const locked = now>cutoff;

    const g = guesses[kamp.id] || {homeGoals:"", awayGoals:""};
    const r = results[kamp.id] || {homeGoals:"", awayGoals:""};

    let pts="";
    if(r.homeGoals!=="" && r.awayGoals!=="" && g.homeGoals!=="" && g.awayGoals!==""){
      const resOutcome=outcome(r.homeGoals,r.awayGoals);
      const guessOutcome=outcome(g.homeGoals,g.awayGoals);
      if(r.homeGoals==g.homeGoals && r.awayGoals==g.awayGoals) pts=pointsConfig.exactScore;
      else if(resOutcome==guessOutcome) pts=pointsConfig.correctOutcome;
      else pts=pointsConfig.wrong;
      totalPoints+=pts;
    }

    const kampDiv = document.createElement('div');
    kampDiv.className = "kamp bg-white shadow-md rounded-lg p-4 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4";
    kampDiv.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2"><img src="${kamp.hjemmeFlag}" class="w-8 h-8"><span>${kamp.hjemmehold}</span></div>
        <span class="font-bold text-xl">vs</span>
        <div class="flex items-center gap-2"><img src="${kamp.udeFlag}" class="w-8 h-8"><span>${kamp.udehold}</span></div>
      </div>

      <div class="flex gap-2">
        <input type="number" min="0" class="score-input" data-match="${kamp.id}" data-type="home" value="${g.homeGoals}" ${locked?"disabled":""}>
        -
        <input type="number" min="0" class="score-input" data-match="${kamp.id}" data-type="away" value="${g.awayGoals}" ${locked?"disabled":""}>
      </div>

      <div class="text-gray-500 text-sm">${kamp.dato} ${kamp.tid} ${locked?"ðŸ”’":""}</div>
      <div class="font-bold">${pts!==""?pts+"p":""}</div>

      ${isAdmin?`<div class="flex gap-2 mt-2 md:mt-0">
        <input type="number" min="0" class="score-input admin" data-match="${kamp.id}" data-type="rhome" value="${r.homeGoals}">
        -
        <input type="number" min="0" class="score-input admin" data-match="${kamp.id}" data-type="raway" value="${r.awayGoals}">
      </div>`:""}
    `;
    contentArea.appendChild(kampDiv);
  });

  document.getElementById("sum-points").textContent = `Samlede point: ${totalPoints}`;
}

/* =========================
   GEM GÃ†T & RESULTATER
========================= */
async function gemGaet(){
  document.querySelectorAll(".score-input[data-match]").forEach(inp=>{
    const id=inp.dataset.match, t=inp.dataset.type;
    if(!guesses[id]) guesses[id]={};
    if(t==="home") guesses[id].homeGoals=inp.value;
    if(t==="away") guesses[id].awayGoals=inp.value;
  });
  const batch = db.batch();
  Object.keys(guesses).forEach(matchId=>{
    const ref=db.collection("users").doc(currentUserUid).collection("guesses").doc(matchId);
    batch.set(ref,{homeGoals:guesses[matchId].homeGoals, awayGoals:guesses[matchId].awayGoals, savedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  });
  await batch.commit();
}

async function gemResultater(){
  document.querySelectorAll(".score-input.admin").forEach(inp=>{
    const id=inp.dataset.match, t=inp.dataset.type;
    if(!results[id]) results[id]={};
    if(t==="rhome") results[id].homeGoals=inp.value;
    if(t==="raway") results[id].awayGoals=inp.value;
  });
  const batch = db.batch();
  Object.keys(results).forEach(matchId=>{
    const ref=db.collection("matches").doc(matchId);
    batch.set(ref,{homeGoals:results[matchId].homeGoals, awayGoals:results[matchId].awayGoals},{merge:true});
  });
  await batch.commit();
}

/* =========================
   HIGHSCORE
========================= */
async function renderHighscore(){
  const highscoreContainer=document.getElementById("highscore-container");
  highscoreContainer.innerHTML="<p>IndlÃ¦ser highscore...</p>";

  const usersSnap=await db.collection("users").get();
  const matchesSnap=await db.collection("matches").get();
  const matchResults={};
  matchesSnap.forEach(doc=>{ matchResults[doc.id]=doc.data(); });

  const scores=[];
  for(const userDoc of usersSnap.docs){
    const uid=userDoc.id;
    const guessesSnap = await userDoc.ref.collection("guesses").get();
    let points=0;
    guessesSnap.forEach(doc=>{
      const guess=doc.data();
      const res=matchResults[doc.id];
      if(res){
        const resOutcome=outcome(res.homeGoals,res.awayGoals);
        const guessOutcome=outcome(guess.homeGoals,guess.awayGoals);
        if(guess.homeGoals==res.homeGoals && guess.awayGoals==res.awayGoals) points+=pointsConfig.exactScore;
        else if(resOutcome==guessOutcome) points+=pointsConfig.correctOutcome;
      }
    });
    scores.push({name:userDoc.data().name||userDoc.data().email, points});
  }

  scores.sort((a,b)=>b.points - a.points);
  highscoreContainer.innerHTML=`
    <table class="w-full border-collapse">
      <thead><tr class="border-b"><th>#</th><th>Bruger</th><th>Point</th></tr></thead>
      <tbody>${scores.map((u,i)=>`<tr class="border-b"><td>${i+1}</td><td>${u.name}</td><td>${u.points}</td></tr>`).join('')}</tbody>
    </table>
  `;
}

/* =========================
   INIT
========================= */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUserEmail=user.email;
    currentUserUid=user.uid;
    isAdmin=(currentUserEmail===ADMIN_EMAIL);

    // hent tidligere gÃ¦t og resultater
    const guessSnap=await db.collection("users").doc(currentUserUid).collection("guesses").get();
    guessSnap.forEach(doc=>{guesses[doc.id]=doc.data();});
    const resultSnap=await db.collection("matches").get();
    resultSnap.forEach(doc=>{results[doc.id]=doc.data();});

    renderKampe();
    renderHighscore();

    // gem-knap
    const gemBtn=document.createElement("button");
    gemBtn.textContent="Gem gÃ¦t/resultater";
    gemBtn.className="mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded hover:bg-blue-700";
    document.querySelector("main").appendChild(gemBtn);
    gemBtn.addEventListener("click", async ()=>{
      if(isAdmin) await gemResultater();
      else await gemGaet();
      renderKampe();
      renderHighscore();
      alert("GÃ¦t/resultater gemt!");
    });

  } else {
    window.location.href="gaet.html";
  }
});
</script>

<style>
.kamp input.score-input{width:40px;text-align:center;}
</style>

</body>
</html>
